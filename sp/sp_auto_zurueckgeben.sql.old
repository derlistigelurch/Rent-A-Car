-- Auto zurückgeben
/*
 * 1. KUNDEN_ID herausfinden
 * 2. EXEMPLAR_ID herausfinden
 * 3. STATUS_ID in Exemplar Tabelle auf 3 (im Haus) setzen
 * 4. In Verleih Tabelle RETOURNIERT auf 1 setzen
 * 5. Falls Schäden vorhanden:
 * 5.1 Checken ob Schaden Bezeichnung in Schaeden Tabelle exisiert, falls nicht --> einfügen
 * 5.2 EXEMPLAR_ID und SCHAEDEN_ID in EXEMP_SCHAEDEN einfügen
 * 5.3 SCHADEN_ID in Exemplar Tabelle updaten
*/
SET SERVEROUTPUT ON;
/
CREATE OR REPLACE PROCEDURE sp_auto_zurueckgeben(l_i_kunde_id_in IN INTEGER, l_bi_schaeden_in IN INTEGER DEFAULT 0, l_v_bezeichnung_in IN VARCHAR2 DEFAULT NULL)
AS
  l_i_exemplar_id INTEGER;
  l_i_status_im_haus INTEGER := 3;
  l_i_schaeden_id INTEGER;
  BEGIN
    COMMIT;
    -- EXEMPLAR_ID herausfinden
    l_i_exemplar_id := pa_exemplar.f_get_exemplar_id_i(l_i_kunde_id_in);
    -- STATUS_ID in Exemplar Tabelle auf 3 (im Haus) setzen
    pa_exemplar.sp_update_status(l_i_exemplar_id, l_i_status_im_haus);
    -- In Verleih Tabelle RETOURNIERT auf 1 setzen
    pa_exemplar.sp_auto_retournieren(l_i_exemplar_id);
    DBMS_OUTPUT.PUT_LINE('Auto (ID ' || l_i_exemplar_id ||') zurückgegeben');
    -- Falls Schäden vorhanden
    IF l_bi_schaeden_in = 1
    THEN
    -- Checken ob Schaden Bezeichnung in Schaeden Tabelle exisiert, falls nicht --> einfügen
      IF pa_schaeden.f_get_schaeden_count_bi(l_v_bezeichnung_in) < 1
      THEN
        l_i_schaeden_id := pa_schaeden.f_insert_schaden_i(l_v_bezeichnung_in);
      ELSE
        l_i_schaeden_id := pa_schaeden.f_get_schaeden_id_i(l_v_bezeichnung_in);
      END IF;
    -- EXEMPLAR_ID und SCHAEDEN_ID in EXEMP_SCHAEDEN einfügen
      pa_schaeden.sp_insert_exemp_schaeden(l_i_exemplar_id, l_i_schaeden_id);
    -- SCHADEN_ID in Exemplar Tabelle updaten
      pa_exemplar.sp_update_schaden(l_i_exemplar_id, l_i_schaeden_id);
      DBMS_OUTPUT.PUT_LINE('Schaden (ID ' || l_i_schaeden_id ||') eingefügt!');
    END IF;
    COMMIT;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      DBMS_OUTPUT.PUT_LINE('Kunde hat kein Auto, dass er zurückgeben könnte!');
      ROLLBACK;
    WHEN OTHERS THEN
      --pa_err.sp_err_handling(SQLCODE, SQLERRM);
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
  END sp_auto_zurueckgeben;
/

COMMIT;